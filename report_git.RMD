---
title: "GIS-Clinical Collaboration: Web-based Report"
author: "[Martin Gleason, MS](mailto:martin.a.gleason@icloud.com)"
date: '`r format(Sys.Date(), "%m/%d/%Y")`'
always_allow_html: yes
output:
  html_document:
    css: pro_presentation_gis.css
---
```{r setup, include=FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = TRUE)

source("me_stream_cleaning.R")

source("me_polygons.R")
library(leaflet)
library(lubridate)
library(tidyverse)
library(kableExtra)

shooting_2017 <- medical_examiner %>%
  filter(year(incident_date) == 2017 & gunrelated == TRUE & age <= 26)
  
```

## The Ask
DCPO Halawa and Data Analyst Loftus asked if it would be possible to use the [Cook County Medical Examiner Office](https://maps.cookcountyil.gov/medexammaps/)(ME) data to supplement the department's internal tracking of shooting incidents with department involved youth. Due to confidentiality concerns regarding department data, this report transforms the ME's data, and does not allow for the identification of specific youth. It is a prototype that can help illustrate the possibilities of GIS powered dashboards and reports within the department's constraints.

### Importing the Data 
Importing the medical examiner's (ME) office data is simple: The [Cook County Open Data website](https://datacatalog.cookcountyil.gov) has a link that, when incorporated into the `R` code of the report, allows for direct connection to the Open Data Portal. This eliminates the need of downloading files, and simplifies the data cleaning process.

### Cleaning Data
Even though this data is coming from directly from the Medical Examiner's database, the data does need to be cleaned. Exploring the data in a tabular format assists in determining which features need to be removed or added to monitor the department's key performance indicators.

```{r head, include= TRUE, echo = FALSE, warnings = FALSE}
me_original %>%
  select(-source) %>%
  head(n = 4) %>%
  kable(format = "html", 
        caption = paste0("Medical Examiner's Office Data: ", 
                         format(today(), "%m/%d/%Y"))) %>%
  kable_styling(bootstrap_options = c("bordered", "hover", "striped", "responsive")) %>%
  scroll_box(width = "100%")
```
For the department's purposes, a number of features should be removed to keep the data clean, including: the age-range of interest to the department and limiting cause of death to gun related incidents. A feature that needs to be improved is the race of the decedent. The way the ME classifies race is complicated. Race is listed as `r unique(me_original$race)`, with Latino being listed as a separate factor. For the department's needs, the ME's data needs to add Latino to race. This is a simple cleaning function in R, that creates the follow categories: `r unique(medical_examiner$race)`

### Visualizing the Data
The cleaned ME data set has following `r length(names(shooting_2017))` columns:
*`r names(shooting_2017)`*. Displaying all of this data in a single column is not useful on paper, but because this report is web based, we can add scroll bars to the table in order to view all the entries.

```{r shootings_2017, echo=FALSE, include= TRUE, warning= FALSE}
shooting_2017 %>% 
  head(n = 10) %>%
  kable(format = "html", 
        caption = paste0("Medical Examiner's Office Data", 
                         format(Sys.Date(), " %m/%d/%Y"))) %>%
  kable_styling(bootstrap_options = c("striped", "bordered", "responsive")) %>%
  scroll_box(width = "100%")
```

A more useful way of displaying the data is summarizing by categories:

```{r summarized, echo = FALSE, message= FALSE, include= TRUE}
shooting_2017 %>% 
  group_by(manner, race, gender) %>%
  summarize(Total = n()) %>%
  kable(format = "html", caption = "2017 Shooting Data Summarized") %>%
  kable_styling(bootstrap_options = c("striped", "bordered", "responsive"))

```

And by plotting the data.

```{r graph, echo = FALSE, message = FALSE, include = TRUE}
shooting_2017 %>% 
  group_by(manner, race, gender) %>%
  summarize(Total = n()) %>%
  ggplot(aes(x = manner, y = Total, fill = race)) + 
  geom_bar(stat = "identity", position = "dodge") + 
  scale_fill_viridis_d() + 
  labs(x = "Type of Shooting", title = "2017 Shooting Data", 
       fill = "Race of Minor", 
       caption = paste0("Data source: Cook County Medical Examiner's Office. Compiled on ",
                        format(Sys.Date(), "%m/%d/%Y"))) + 
  theme(plot.background = element_rect(fill = "#F5F5F5")) + 
  theme_minimal() +
  facet_wrap( ~ gender)
```

In short, the data can be filtered, selected and summarized for [descriptive statistics](https://en.wikipedia.org/wiki/Descriptive_statistics), or displayed as a variety of graphs. Additionally, this data can be combined with the tracking done by the department to determine program and intervention effectiveness. Adding this type of analytical tool, while beyond the scope of this report, is well within the capability of the Office of the Chief Judge and the Department, and would add significant analytic capability at a minimal cost.

## GIS
Utilizing Geographic Information Systems was the critical ask of this report. The ME's office already uses Cook County's GIS department to map the data.The department, however, has other geographic areas of interest; specifically, police district, judicial district, Cook County Commissioner District and a yet-to-be-defined *probation district.* 

It would be possible to build more interactive web reports. For example, allowing users to select the geographical boundaries to overlay on the incidents or including violent deaths that do not involve gun crimes. For this prototype, the report is limited to one series of boundaries one one data set; however, this report does allow for zooming into particular geographic locales.


### Cook County Shooting Incidents by Commissioner District: 2016 - Today
```{r me_commish_point, include= TRUE, echo = FALSE, warning = FALSE, fig.cap= "Cook County Shooting Incidents by Comminsioner District: 2016 - Today. Source Cook County Medical Examiner's Office"}

me_sf <- medical_examiner %>%
  filter(!is.na(longitude)) %>%
  st_as_sf(coords = c("longitude", "latitude"),
           crs= "+proj=longlat +datum=WGS84")

pal <- colorFactor(palette = "viridis",
                   domain = me_sf$manner)

leaflet(commish_districts) %>%
  addProviderTiles("Stamen.TonerLite") %>%
  setView(lng = -87.7, lat = 41.9, zoom = 11) %>%
  addPolygons(color = "black",
              fillColor = "#ADD8E600",
              label = paste0(commish_districts$district, "\n",
                             commish_districts$firstname, " ", 
                             commish_districts$lastname)) %>%
  addMarkers(lng = -87.68108, lat = 41.86767,
             label = "Cook County Juvenile Justice Center") %>%
  addCircles(data = filter(me_sf, age <=26 &
                             age > 12 & 
                             year(incident_date) >= 2016 & 
                            gunrelated == TRUE),
             color = ~pal(manner)) %>%
  addLegend("bottomright", pal = pal,
            value= ~me_sf$manner,
            title = "Manner of Incident") 

```


### Medical Examiner

A note about the data sets: The ME data was initially downloaded and cleaned before mapped. Their records were missing 16 location entries. In a more formal report, these missing records would be more thoroughly examined. For this proof of concept, they were simply removed from the data set.

## Displaying Reports
Using the data and methods contained in this document, creating a GIS-informed report that runs regularly would be a relatively simple task. Creating a dashboard or app to display the same data would only be marginally more intensive. It would require installing `R` and `RStudio` on the Chief Judge's servers. Given that OCJ has already begun the process of deploying Linux servers to support the new case plan system, adding another Linux instance on the OCJ intranet is neither a technical nor a cost prohibitive step. The most pressing concern about a dashboard/app would be getting permission from County stakeholders to approve the use of an internal web server.

The advantages of a dashboard/app would be the ability to filter the data sets and display them in real time, instead of "hard coding" results like this report. This method would increase collaboration, free up staff time for other analysis, generate less paper, and allow for easy access for all OCJ staff. These tools would also supplement the dashboard and report ability of the department's new case management system, [cFive](https://www.cfive.com/products/supervisor/). cFive's demonstrated dashboards, while customizable, do not have the same capabilities (GIS, importing ME data, etc) as this report. The methods demonstrated in this prototype can be directly applied to cFive's reporting structure. 

## Recap and Next Steps
Medical Examiner office and court data can be easily combined to track and measure shooting deaths of court involved. Collecting, cleaning, and visualizing this data was demonstrated in this prototype and can be deployed to the department shortly after cFive's reporting system goes live. Expanding this capacity into dashboards is possible with a minor addition to the OCJ's infrastructure. The primary barrier to dashboard development, is ensuring that the dashboard are not accessible to the public. While this is a technical issue that is beyond the scope of this report, the Office of the Chief Judge has already begun to deploy an additional server to host cFive's reporting services. An additional Linux server, configured to host dashboards and R functionality, would be a mid scale IT project that could dramatically increase the department's analytic capability without cost to the department's capital expenditures. Such a project is the logical next step of this analysis, and can begin once cFive's reporting feature goes live.